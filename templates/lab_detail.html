<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ lab.code }} | MCK Infra Labs</title>
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body>
    <div class="noise"></div>
    <header class="topbar">
      <div class="brand">MCK Infra Labs</div>
      <nav class="top-links">
        <a class="ghost-link" href="/">Lab hub</a>
        {% if lab.leaderboard_enabled %}
        <a class="ghost-link" href="/leaderboard?lab={{ lab.id }}">Leaderboard</a>
        {% endif %}
        <a class="ghost-link" href="/admin">Admin</a>
      </nav>
    </header>

    <main class="page">
      <div id="lab-context" data-lab-id="{{ lab.id }}" data-compare-enabled="{{ 'true' if lab.compare_enabled else 'false' }}"></div>

      <section class="hero lab-hero">
        <div class="badge">{{ lab.code }}</div>
        <h1>{{ lab.title }}</h1>
        <p>{{ lab.tagline }}</p>
        <div class="hero-meta">
          <span class="pill">Automation: {{ 'Yes' if lab.automation_enabled else 'No' }}</span>
          <span class="pill">Leaderboard: {{ 'Yes' if lab.leaderboard_enabled else 'No' }}</span>
          <span class="pill">Verifier: {{ 'Enabled' if lab.compare_enabled else 'Manual' }}</span>
        </div>
      </section>

      <section class="panel brief-panel">
        <div class="results-header">
          <h2>Lab brief</h2>
          <span class="muted">{{ lab.summary }}</span>
        </div>
        <div class="brief-grid">
          {% for fact in lab.facts %}
          <div class="brief-card">
            <span class="brief-label">{{ fact.title }}</span>
            <p>{{ fact.body }}</p>
          </div>
          {% endfor %}
        </div>
      </section>

      <section class="panel steps-panel">
        <div class="results-header">
          <h2>Required steps</h2>
          <span class="muted">Complete these in order to finish the lab.</span>
        </div>
        <ol class="steps-list">
          {% for step in lab.steps %}
          <li class="steps-item">
            <div class="steps-body">
              <h3>{{ step.title }}</h3>
              <p>{{ step.body }}</p>
            </div>
            {% if step.output %}
            <span class="step-output">{{ step.output }}</span>
            {% endif %}
            {% if step.details or step.code or step.downloads %}
            {% set modal_payload = {
              "title": step.title,
              "details": step.details | default(""),
              "code": step.code | default(""),
              "downloads": step.downloads | default([])
            } %}
            <button
              type="button"
              class="ghost-link detail-trigger"
              data-modal='{{ modal_payload | tojson }}'
            >
              View details
            </button>
            {% endif %}
          </li>
          {% endfor %}
        </ol>
      </section>

      <section class="panel">
        <div class="results-header">
          <h2>Deliverables</h2>
          <span class="muted">What you must submit or prove.</span>
        </div>
        <div class="section-grid">
          {% for item in lab.deliverables %}
          <div class="section-card">
            <h3>{{ item.title }}</h3>
            <p>{{ item.body }}</p>
          </div>
          {% endfor %}
        </div>
      </section>

      <section class="panel">
        <div class="results-header">
          <h2>Validation checklist</h2>
          <span class="muted">Use this list to confirm completion.</span>
        </div>
        <ul class="checklist">
          {% for item in lab.validation %}
          <li>{{ item }}</li>
          {% endfor %}
        </ul>
      </section>

      <section class="panel">
        <div class="results-header">
          <h2>Resources</h2>
          <span class="muted">Links and references for this lab.</span>
        </div>
        <div class="section-grid">
          {% for item in lab.resources %}
          <div class="section-card">
            <h3>{{ item.title }}</h3>
            <p>{{ item.body }}</p>
            {% if item.body and item.body.startswith("http") %}
            <a class="primary-link resource-link" href="{{ item.body }}" target="_blank" rel="noreferrer">
              Open link
            </a>
            {% endif %}
          </div>
          {% endfor %}
        </div>
      </section>

      {% for section in lab.sections %}
      <section class="panel">
        <div class="results-header">
          <h2>{{ section.title }}</h2>
        </div>
        <div class="section-grid">
          {% for item in section["items"] %}
          <div class="section-card">
            <h3>{{ item.title }}</h3>
            <p>{{ item.body }}</p>
          </div>
          {% endfor %}
        </div>
      </section>
      {% endfor %}

      {% if lab.submission_enabled or lab.leaderboard_enabled %}
      <section class="panel">
        <div class="results-header">
          <h2>Submission and verification</h2>
          <span class="muted">{{ lab.form_helper }}</span>
        </div>
        <div class="split-panel">
          {% if lab.submission_enabled %}
          <div>
            <form id="compare-form" data-lab-id="{{ lab.id }}" data-compare-enabled="{{ 'true' if lab.compare_enabled else 'false' }}">
              <div class="field">
                <label for="name">Student name</label>
                <input id="name" name="name" type="text" placeholder="e.g. Priya Patel" required />
              </div>
              <div class="field">
                <label for="url">Student app URL</label>
                <input
                  id="url"
                  name="url"
                  type="url"
                  placeholder="https://your-app.example.com"
                  required
                />
              </div>
              <button type="submit" id="submit-btn">{{ lab.form_cta }}</button>
            </form>

            <div id="status" class="status hidden"></div>

            <div id="results" class="results hidden">
              <div class="results-header">
                <h2>Comparison results</h2>
                <span id="elapsed"></span>
              </div>
              <div id="summary" class="summary"></div>
              <div id="result-list" class="result-list"></div>
            </div>

            {% if not lab.compare_enabled %}
            <div class="callout">
              Automated verification is not enabled for this lab yet. Submissions are
              tracked for manual review.
            </div>
            {% endif %}
          </div>
          {% endif %}

          <div class="stack">
            {% if lab.submission_enabled %}
            <div class="students">
              <div class="results-header">
                <h2>Registered apps</h2>
                <button type="button" id="refresh-students" class="ghost">Refresh list</button>
              </div>
              <div id="students-list" class="students-list"></div>
            </div>
            {% endif %}

            {% if lab.leaderboard_enabled %}
            <div class="students">
              <div class="results-header">
                <h2>Progress board</h2>
                <button type="button" id="refresh-leaderboard" class="ghost">Refresh board</button>
              </div>
              {% if lab.compare_enabled %}
              <div class="status ok" id="compare-timer" data-interval-seconds="{{ compare_interval_seconds }}">
                Next sync check in {{ compare_interval_seconds }}s
              </div>
              {% else %}
              <div class="status">Manual review in progress.</div>
              {% endif %}
              <div id="leaderboard-list" class="students-list"></div>
            </div>
            {% endif %}
          </div>
        </div>
      </section>
      {% endif %}

      {% if teams %}
      <section class="panel">
        <div class="results-header">
          <h2>Teams</h2>
        </div>
        <div class="section-grid">
          {% for team in teams %}
          <div class="section-card">
            <h3>{{ team.name }}</h3>
            <p>{{ team.members }}</p>
          </div>
          {% endfor %}
        </div>
      </section>
      {% endif %}

      {% if lab.automation_enabled %}
      <section class="panel">
        <div class="results-header">
          <h2>Automation logs</h2>
          <span id="log-count">0 entries</span>
        </div>
        <div class="status" id="auto-fill-timer" data-next-seconds="0">Automation pending</div>
        <div class="status">Next entry: <span id="auto-fill-entry">Pending</span></div>
        <div class="log-box" id="log-box"></div>
      </section>
      {% endif %}
    </main>

    <div class="modal hidden" id="detail-modal" aria-hidden="true">
      <div class="modal-backdrop" data-modal-close></div>
      <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <div class="modal-header">
          <h2 id="modal-title">Details</h2>
          <button type="button" class="modal-close" data-modal-close>Close</button>
        </div>
        <div class="modal-body">
          <p id="modal-details"></p>
          <div id="modal-code-block" class="modal-code hidden">
            <div class="modal-subtitle">Code</div>
            <pre><code id="modal-code"></code></pre>
          </div>
          <div id="modal-downloads" class="modal-downloads hidden">
            <div class="modal-subtitle">Downloads</div>
            <div id="modal-download-list" class="modal-download-list"></div>
          </div>
        </div>
      </div>
    </div>

    <script src="/static/app.js"></script>
  </body>
</html>
